{{- $localBridgeHost := or (eq .Values.bridge.host "127.0.0.1") (eq .Values.bridge.host "localhost") (eq .Values.bridge.host "::1") -}}
{{- if and $localBridgeHost (eq (toString .Values.bridge.smtpPort) (toString .Values.container.smtpPort)) -}}
{{- fail "invalid proton-bridge values: bridge.smtpPort must differ from container.smtpPort when bridge.host is local" -}}
{{- end -}}
{{- if and $localBridgeHost (eq (toString .Values.bridge.imapPort) (toString .Values.container.imapPort)) -}}
{{- fail "invalid proton-bridge values: bridge.imapPort must differ from container.imapPort when bridge.host is local" -}}
{{- end -}}
{{- if not .Values.existingSecret }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "proton-bridge.secretName" . }}
  labels:
    {{- include "proton-bridge.labels" . | nindent 4 }}
type: Opaque
stringData:
  PROTON_BRIDGE_HOST: {{ .Values.bridge.host | quote }}
  PROTON_BRIDGE_SMTP_PORT: {{ .Values.bridge.smtpPort | quote }}
  PROTON_BRIDGE_IMAP_PORT: {{ .Values.bridge.imapPort | quote }}
  CONTAINER_SMTP_PORT: {{ .Values.container.smtpPort | quote }}
  CONTAINER_IMAP_PORT: {{ .Values.container.imapPort | quote }}
{{- end }}
