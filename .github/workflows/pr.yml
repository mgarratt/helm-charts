name: pr

on:
  pull_request:

permissions:
  contents: read

jobs:
  static:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2
        with:
          cache: true

      - name: Lint charts
        run: ./scripts/lint.sh

      - name: Install kubeconform
        shell: bash
        run: |
          set -euo pipefail
          ver=v0.6.7
          url="https://github.com/yannh/kubeconform/releases/download/${ver}/kubeconform-linux-amd64.tar.gz"
          curl -fsSL "$url" -o /tmp/kubeconform.tar.gz
          tar -xzf /tmp/kubeconform.tar.gz -C /tmp kubeconform
          sudo install -m 0755 /tmp/kubeconform /usr/local/bin/kubeconform

      - name: Validate rendered manifests
        shell: bash
        run: |
          set -euo pipefail
          while IFS= read -r chart; do
            dir="$(dirname "$chart")"
            if [[ "$(basename "$dir")" == "_template" ]]; then
              continue
            fi
            echo "[kubeconform] ${dir}"
            helm template ci "$dir" | kubeconform -strict -summary -ignore-missing-schemas
          done < <(find charts -mindepth 2 -maxdepth 2 -type f -name Chart.yaml | sort)

  install:
    runs-on: ubuntu-latest
    needs: [static]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: jdx/mise-action@v2
        with:
          cache: true

      - uses: helm/chart-testing-action@v2.7.0

      - uses: helm/kind-action@v1.12.0
        with:
          version: v0.25.0

      - name: Lint changed charts (ct)
        run: ct lint --config .ct.yaml --target-branch "${{ github.event.pull_request.base.ref }}"

      - name: Install changed charts in kind (ct)
        run: ct install --config .ct.yaml --target-branch "${{ github.event.pull_request.base.ref }}"
